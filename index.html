<!DOCTYPE HTML>
<html lang="en">
    
<head>
    
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="">
    <meta name="author" content="">

    <title>Esper    </title>
    
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
    <link href="speech.css" rel="stylesheet" type="text/css"/>
    <link href="https://fonts.googleapis.com/css?family=Montez" rel="stylesheet">
    
     <!-- Bootstrap core CSS -->
    <link href="home/vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Custom fonts for this template -->
    <link href="home/vendor/font-awesome/css/font-awesome.min.css" rel="stylesheet" type="text/css">
    
    <link href='https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' rel='stylesheet' type='text/css'>
    <link href='https://fonts.googleapis.com/css?family=Merriweather:400,300,300italic,400italic,700,700italic,900,900italic' rel='stylesheet' type='text/css'>
    
    <!-- Plugin CSS -->
    <link href="home/vendor/magnific-popup/magnific-popup.css" rel="stylesheet">
    
    <!-- Custom styles for this template -->
    <link href="home/css/creative.min.css" rel="stylesheet">
    
    <script src = "bundle.js"></script>
</head>

<body id="page-top">

    <script src="speech.js"></script>
    <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>
        
        <div id="warning" style="display:none">
            <h1 style="font-weight:500;">Speech Recognition SDK not found.</h1>
            <h2 style="font-weight:500;">Please execute <code>npm run bundle</code> and reload.</h2>
        </div>
    <div id="particles-js" style="position:fixed;width:100%;background-color:#343434;"></div>
    <script src="particles.js"></script>
    <script src="app.js"></script>


    <!-- new ui-->
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-light fixed-top" id="mainNav">
      <div class="container">
        <a class="navbar-brand js-scroll-trigger" href="#page-top"></a>
        <button class="navbar-toggler navbar-toggler-right" type="button" data-toggle="collapse" data-target="#navbarResponsive" aria-controls="navbarResponsive" aria-expanded="false" aria-label="Toggle navigation">
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarResponsive">
          <ul class="navbar-nav ml-auto" style="right: 1%;position: fixed;top: 2%;">
            <li class="nav-item">
              <a class="nav-link js-scroll-trigger" href="#about">About</a>
            </li>
            <li class="nav-item">
              <a class="nav-link js-scroll-trigger" href="#services">Services</a>
            </li>
            <li class="nav-item">
              <a class="nav-link js-scroll-trigger" href="#contact">Contact</a>
            </li>
          </ul>
        </div>
      </div>
    </nav>

    <header class="masthead text-center text-white d-flex">
      <div class="container my-auto">
        <div class="row">
          <div class="col-lg-10 mx-auto">
            <!--<h1 class="text-uppercase">
              <strong>Shift</strong>
            </h1>-->
              <div class="project_name hidden">
                  <img src="img/project_name.gif">
              </div>
              <a class="text-faded nav-link" id="link_sink" style="font-family: 'Open Sans', 'Helvetica Neue', Arial, sans-serif;font-weight: 700;font-size: large;"></a>
            <!--<hr>-->
            <div>
                <img id="pink_line" src="img/pink_line.gif" style="max-width: 12%;">
            </div>
          </div>
          <div class="col-lg-8 mx-auto">
            <div class="hidden">
                <p class="text-faded mb-5" id="output_text">Let's talk</p>
            </div>
            <a class="btn btn-primary btn-xl js-scroll-trigger" href="#" id="startBtn">Start</a>
            <a class="btn btn-primary btn-xl js-scroll-trigger" href="#" id="stopBtn">Stop</a>
          </div>
        </div>
      </div>
    </header>
    
    
    <!-- Bootstrap core JavaScript -->
    <script src="home/vendor/jquery/jquery.min.js"></script>
    <script src="home/vendor/bootstrap/js/bootstrap.bundle.min.js"></script>

    <!-- Plugin JavaScript -->
    <script src="home/vendor/jquery-easing/jquery.easing.min.js"></script>
    <script src="home/vendor/scrollreveal/scrollreveal.min.js"></script>
    <script src="home/vendor/magnific-popup/jquery.magnific-popup.min.js"></script>

    <!-- Custom scripts for this template -->
    <script src="home/js/creative.min.js"></script>

    
    <!--end-->
    
    
    
    <div id="content" style="display:none">
        <table width="100%" style="display:none">
            <tr>
                <input id="key" style="display:none" type="text" size="40" value="30f9e601bedb4f59916b6fd7f3d20624">
            </tr>
            
            <tr>
                <td>
                    <button id="startBtn" disabled="disabled">Start</button>
                    <button id="stopBtn" disabled="disabled">Stop</button>
                    <input type="file" id="filePicker" accept=".wav" style="display:none"/>
                </td>
            </tr>
            <tr>
                <td>
                    <table>
                        <tr>
                            <td>Results:</td>
                            <td>Current hypothesis:</td>
                        </tr>
                        <tr>
                            <td>
                                <textarea id="phraseDiv" style="display: inline-block;width:500px;height:200px"></textarea>
                            </td>
                            <td style="vertical-align: top">
                                <span id="hypothesisDiv" style="width:200px;height:200px;display:block;"></span>
                            </td>
                        </tr>
                    </table>
                </td>
            </tr>
            <tr>
                <td align="right">Status:</td>
                <td align="left"><span id="statusDiv"></span></td>
            </tr>
        </table>
    </div>

    <!-- SDK REFERENCE -->
    <script src="../../speech/distrib/speech.sdk.bundle.js"></script>
    
    <script src='https://code.responsivevoice.org/responsivevoice.js'></script>
    
    <script>
        // Example 4: implements app actions.
        var ConversationV1 = require('watson-developer-cloud/conversation/v1');
        var endConversation = false;
    
            
        // Set up Conversation service wrapper.
        window.conversation = new ConversationV1({
          username: '62c028a8-814f-499f-92b7-cd19884de4ac', // replace with service username
          password: 'aXVgNhLkOPYL', // replace with service password
          version_date: '2017-05-26',
        });

        var workspace_id = 'c84df8e6-af10-45b5-9c09-4d5355dd74e7'; // replace with workspace ID

        // Start conversation with empty message.
        conversation.message({
          workspace_id: workspace_id
          }, processResponse);

        // Process the conversation response.
        function processResponse(err, response) {
          window.watResponse = response;
            
          if (err) {
            console.error(err); // something went wrong
            return;
          }

           endConversation = false;

          // Check for flags.
        if (response.output.link == 'cmha') {
            window.link = "https://cmha.ca/";
        } else if (response.output.link == 'suicide') {
            window.link = "https://suicideprevention.ca/need-help/";
        } else {
            window.link = "";
        }
            
            
          if (response.output.action === 'display_time') {
            // User asked what time it is, so we output the local system time.
            console.log('The current time is ' + new Date().toLocaleTimeString());
          } else {
            // Display the output from dialog, if any.
            if (response.output.text.length != 0) {
                document.getElementById("output_text").innerHTML = response.output.text[0];
                if(window.link != ""){
                    var linkSink = document.getElementById("link_sink")
                    linkSink.innerHTML = "GO";
                    linkSink.setAttribute("href", window.link);
                    linkSink.setAttribute("target", "_blank");
                    linkSink.classList.add("hidden");
                    $('a.hidden').fadeIn(4000).removeClass('hidden');
                }
                responsiveVoice.speak(response.output.text[0], "UK English Female", {rate: 0.85});
            }
          }
        }
    </script>
    
    <!-- SDK USAGE -->
    <script>
     //   var newMessageFromUser;
        // On document load resolve the SDK dependency
        function Initialize(onComplete) {
            if (!!window.SDK) {
                document.getElementById('content').style.display = 'block';
                document.getElementById('warning').style.display = 'none';
                onComplete(window.SDK);
            }
        }
        
        // Setup the recognizer
        function RecognizerSetup(SDK, recognitionMode, language, format, subscriptionKey) {
            
                    recognitionMode = SDK.RecognitionMode.Dictation; 

            var recognizerConfig = new SDK.RecognizerConfig(
                new SDK.SpeechConfig(
                    new SDK.Context(
                        new SDK.OS(navigator.userAgent, "Browser", null),
                        new SDK.Device("SpeechSample", "SpeechSample", "1.0.00000"))),
                recognitionMode,
                language, // Supported languages are specific to each recognition mode. Refer to docs.
                format); // SDK.SpeechResultFormat.Simple (Options - Simple/Detailed)


            var useTokenAuth = false;
            
            var authentication = function() {
                if (!useTokenAuth)
                    return new SDK.CognitiveSubscriptionKeyAuthentication(subscriptionKey);

                var callback = function() {
                    var tokenDeferral = new SDK.Deferred();
                    try {
                        var xhr = new(XMLHttpRequest || ActiveXObject)('MSXML2.XMLHTTP.3.0');
                        xhr.open('GET', '/token', 1);
                        xhr.onload = function () {
                            if (xhr.status === 200)  {
                                tokenDeferral.Resolve(xhr.responseText);
                            } else {
                                tokenDeferral.Reject('Issue token request failed.');
                            }
                        };
                        xhr.send();
                    } catch (e) {
                        window.console && console.log(e);
                        tokenDeferral.Reject(e.message);
                    }
                    return tokenDeferral.Promise();
                }

                return new SDK.CognitiveTokenAuthentication(callback, callback);
            }();
            
            var files = document.getElementById('filePicker').files;
            if (!files.length) {
                return SDK.CreateRecognizer(recognizerConfig, authentication);
            } else {
                return SDK.CreateRecognizerWithFileAudioSource(recognizerConfig, authentication, files[0]);
            }
        }

        // Start the recognition
        function RecognizerStart(SDK, recognizer) {
            recognizer.Recognize((event) => {
                /*
                 Alternative syntax for typescript devs.
                 if (event instanceof SDK.RecognitionTriggeredEvent)
                */
                document.title = "Esper     ";
                switch (event.Name) {
                    case "RecognitionTriggeredEvent" :
                        UpdateStatus("Initializing");
                        break;
                    case "ListeningStartedEvent" :
                        UpdateStatus("Listening");
                        break;
                    case "RecognitionStartedEvent" :
                        UpdateStatus("Listening_Recognizing");
                        break;
                    case "SpeechStartDetectedEvent" :
                        UpdateStatus("Listening_DetectedSpeech_Recognizing");
                        console.log(JSON.stringify(event.Result)); // check console for other information in result
                        break;
                    case "SpeechHypothesisEvent" :
                        UpdateRecognizedHypothesis(event.Result.Text, false);
                        console.log(JSON.stringify(event.Result)); // check console for other information in result
                        break;
                    case "SpeechFragmentEvent" :
                        UpdateRecognizedHypothesis(event.Result.Text, true);
                        console.log(JSON.stringify(event.Result)); // check console for other information in result
                        break;
//                    case "SpeechEndDetectedEvent" :
//                        OnSpeechEndDetected();
//                        UpdateStatus("Processing_Adding_Final_Touches");
//                        console.log(JSON.stringify(event.Result)); // check console for other information in result
//                        break;
                    case "SpeechSimplePhraseEvent" :
                        //document.getElementById("pink_line").setAttribute("src", "img/pink_line.gif");
                        UpdateRecognizedPhrase(JSON.stringify(event.Result, null, 3));
                        break;
                    case "RecognitionEndedEvent" :
                        OnComplete();
                        UpdateStatus("Idle");
                        console.log(JSON.stringify(event)); // Debug information
                        break;
                    default:
                        console.log(JSON.stringify(event)); // Debug information
                }
            })
            .On(() => {
                // The request succeeded. Nothing to do here.
            },
            (error) => {
                console.error(error);
            });
        }

        // Stop the Recognition.
        function RecognizerStop(SDK, recognizer) {
            // recognizer.AudioSource.Detach(audioNodeId) can be also used here. (audioNodeId is part of ListeningStartedEvent)
            recognizer.AudioSource.TurnOff();
            document.title = "Esper    ";
            //window.alert(phraseDiv.innerHTML);
            var conversation = window.conversation
            
            var newMessageFromUser=phraseDiv.innerHTML;
            newMessageFromUser = newMessageFromUser.replace(/(\r\n|\n|\r)/gm,"");
            // alert(response.output);
           // If we're not done, prompt for the next round of input.

            conversation.message({
              workspace_id: 'c84df8e6-af10-45b5-9c09-4d5355dd74e7',
              input: { text: newMessageFromUser },
              // Send back the context to maintain state.
            //   context :  window.watResponse.context,
            }, processResponse)
        }
    </script>

    <!-- Browser Hooks -->
    <script>
        var startBtn, stopBtn, hypothesisDiv, phraseDiv, statusDiv;
        var key, filePicker;
        var SDK;
        var recognizer;
        var previousSubscriptionKey;

        document.addEventListener("DOMContentLoaded", function () {
            createBtn = document.getElementById("createBtn");
            startBtn = document.getElementById("startBtn");
            stopBtn = document.getElementById("stopBtn");
            phraseDiv = document.getElementById("phraseDiv");
            hypothesisDiv = document.getElementById("hypothesisDiv");
            statusDiv = document.getElementById("statusDiv");
            key = document.getElementById("key");
            filePicker = document.getElementById('filePicker');

            startBtn.addEventListener("click", function () {
                if (key.value == "" || key.value == "YOUR_BING_SPEECH_API_KEY") {
                    alert("Please enter your Bing Speech subscription key!");
                    return;
                }
                if (!recognizer || previousSubscriptionKey != key.value) {
                    previousSubscriptionKey = key.value;
                    Setup();
                }

                if(startBtn.disabled != true){
                    document.getElementById("pink_line").setAttribute("src", "img/pink_line.gif");
                    hypothesisDiv.innerHTML = "";
                    phraseDiv.innerHTML = "";
                    RecognizerStart(SDK, recognizer);
                    startBtn.disabled = true;
                    stopBtn.disabled = false;   
                }
            });

            key.addEventListener("focus", function () {
               if (key.value == "YOUR_BING_SPEECH_API_KEY") {
                   key.value = "";
               }
            });

            key.addEventListener("focusout", function () {
               if (key.value == "") {
                   key.value = "YOUR_BING_SPEECH_API_KEY";
               }
            });

            stopBtn.addEventListener("click", function () {
                if(stopBtn.disabled != true){
                    document.getElementById("pink_line").setAttribute("src", "img/pink_line.gif");              
                    RecognizerStop(SDK, recognizer);
                    startBtn.disabled = false;
                    stopBtn.disabled = true;   
                }
            });

            Initialize(function (speechSdk) {
                SDK = speechSdk;
                startBtn.disabled = false;
            });
        });

        function Setup() {
            if (recognizer != null) {
                RecognizerStop(SDK, recognizer);
            }
            recognizer = RecognizerSetup(SDK, "Dictation", "en-US", SDK.SpeechResultFormat["Simple"], key.value);
        }

        function UpdateStatus(status) {
            statusDiv.innerHTML = status;
        }

        function UpdateRecognizedHypothesis(text, append) {
            if (append) 
                hypothesisDiv.innerHTML += text + " ";
            else 
                hypothesisDiv.innerHTML = text;

            var length = hypothesisDiv.innerHTML.length;
            if (length > 403) {
                hypothesisDiv.innerHTML = "..." + hypothesisDiv.innerHTML.substr(length-400, length);
            }
        }

        function OnSpeechEndDetected() {
            stopBtn.disabled = true;
        }

        function UpdateRecognizedPhrase(json) {
            hypothesisDiv.innerHTML = "";
            if (!(JSON.parse(json).DisplayText=== "undefined")) {
                phraseDiv.innerHTML += JSON.parse(json).DisplayText + "\n";
            }
            document.title = "Esper ... ";
        }

        function OnComplete() {
            document.title = "Esper    ";
            //document.getElementById("pink_line").setAttribute("src", "img/pink_line.gif");
            startBtn.disabled = false;
            stopBtn.disabled = true;
        }
    </script>
</body>    
</html>